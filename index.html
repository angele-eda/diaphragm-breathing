<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Breathing Timer - íš¡ê²©ë§‰ í˜¸í¡</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4b82ff">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    body {
      margin: 0;
      padding: 0;
      text-align: center;
      background: #eef2f9;
      font-family: "Pretendard", sans-serif;
    }

    header img {
      width: 100%;
      border-bottom-left-radius: 18px;
      border-bottom-right-radius: 18px;
    }

    h2 {
      margin-top: 18px;
      font-size: 22px;
      font-weight: 700;
    }

    .btnWrap {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .mode-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: #4B82FF;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }

    #modeImage {
      width: 85%;
      margin-top: 20px;
      border-radius: 12px;
    }

    #timer {
      font-size: 28px;
      margin-top: 15px;
      font-weight: 700;
      color: #333;
    }

    #banner {
      margin: 22px 0 70px; /* ì•„ë˜ ì„¤ì¹˜ë°”ë‘ ì•ˆ ê²¹ì¹˜ê²Œ ì—¬ìœ  */
      width: 100%;
    }

    /* ğŸ”» í•˜ë‹¨ ì„¤ì¹˜/ë°”ë¡œê°€ê¸° ë°” */
    #installBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.96);
      border-top: 1px solid #d0d6e6;
      padding: 8px 10px 10px;
      display: none; /* beforeinstallprompt ëœ° ë•Œë§Œ ë³´ì—¬ì¤Œ */
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
      z-index: 999;
    }

    #installBarInner {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .install-btn {
      flex: 1;
      padding: 10px 6px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    #btnInstall {
      background: #4B82FF;
      color: #fff;
    }

    #btnHomeHint {
      background: #eef2f9;
      color: #333;
    }
  </style>
</head>

<body>

  <!-- ìƒë‹¨ íˆì–´ë¡œ ì´ë¯¸ì§€ -->
  <header>
    <img src="img/hero_main.png" alt="Breathing Timer Hero">
  </header>

  <h2>í˜¸í¡ë²• ì„ íƒ</h2>

  <div class="btnWrap">
    <button class="mode-btn" onclick="selectMode('426')">4-2-6 í˜¸í¡</button>
    <button class="mode-btn" onclick="selectMode('478')">4-7-8 ìˆ˜ë©´ í˜¸í¡</button>
    <button class="mode-btn" onclick="selectMode('box')">4-4-4-4 ë°•ìŠ¤ í˜¸í¡</button>
  </div>

  <!-- ì„ íƒëœ í˜¸í¡ ì´ë¯¸ì§€ -->
  <img id="modeImage" src="img/426.png" alt="í˜¸í¡ ëª¨ë“œ ì´ë¯¸ì§€">

  <!-- íƒ€ì´ë¨¸ í‘œì‹œ -->
  <div id="timer">ì¤€ë¹„</div>

  <!-- ìˆ˜ë©´ìš© ë°°ë„ˆ -->
  <img id="banner" src="img/banner_sleep.png" alt="ìˆ˜ë©´ ë°°ë„ˆ">

  <!-- ğŸ”» í•˜ë‹¨: ì•± ì„¤ì¹˜ / í™ˆ ë°”ë¡œê°€ê¸° ì•ˆë‚´ ë°” -->
  <div id="installBar">
    <div id="installBarInner">
      <button class="install-btn" id="btnInstall">ğŸ“² ì•± ì„¤ì¹˜</button>
      <button class="install-btn" id="btnHomeHint">ğŸ  í™ˆ ë°”ë¡œê°€ê¸° ì•ˆë‚´</button>
    </div>
  </div>

<script>
  // ====== í˜¸í¡ íƒ€ì´ë¨¸ + ìˆ¨ì†Œë¦¬ ======
  const inhaleSound = new Audio("sound/soft_sleep_chime.wav");
  const exhaleSound = new Audio("sound/bells_sound1_custom.wav");

  const timerEl = document.getElementById("timer");
  const modeImage = document.getElementById("modeImage");

  let breathingPattern = [];
  let stepIndex = 0;
  let running = false;

  function selectMode(mode) {
    running = false;
    stepIndex = 0;

    if (mode === "426") {
      modeImage.src = "img/426.png";
      breathingPattern = [
        { state: "ë“¤ìˆ¨", sec: 4 },
        { state: "ë©ˆì¶¤", sec: 2 },
        { state: "ë‚ ìˆ¨", sec: 6 }
      ];
    } else if (mode === "478") {
      modeImage.src = "img/478.png";
      breathingPattern = [
        { state: "ë“¤ìˆ¨", sec: 4 },
        { state: "ë©ˆì¶¤", sec: 7 },
        { state: "ë‚ ìˆ¨", sec: 8 }
      ];
    } else if (mode === "box") {
      modeImage.src = "img/box.png";
      breathingPattern = [
        { state: "ë“¤ìˆ¨", sec: 4 },
        { state: "ë©ˆì¶¤", sec: 4 },
        { state: "ë‚ ìˆ¨", sec: 4 },
        { state: "ë©ˆì¶¤", sec: 4 }
      ];
    }

    startBreathing();
  }

  function startBreathing() {
    if (!breathingPattern.length) return;
    running = true;
    stepIndex = 0;
    runStep();
  }

  function runStep() {
    if (!running) return;

    const step = breathingPattern[stepIndex];
    let remaining = step.sec;

    timerEl.textContent = `${step.state} (${remaining}s)`;

    if (step.state === "ë“¤ìˆ¨") inhaleSound.play();
    if (step.state === "ë‚ ìˆ¨") exhaleSound.play();

    const interval = setInterval(() => {
      if (!running) {
        clearInterval(interval);
        return;
      }

      remaining--;
      timerEl.textContent = `${step.state} (${remaining}s)`;

      if (remaining <= 0) {
        clearInterval(interval);
        stepIndex = (stepIndex + 1) % breathingPattern.length;
        runStep();
      }
    }, 1000);
  }

  // ====== PWA ì„¤ì¹˜ / í•˜ë‹¨ ë°” ì œì–´ ======
  let deferredPrompt = null;
  const installBar = document.getElementById("installBar");
  const btnInstall = document.getElementById("btnInstall");
  const btnHomeHint = document.getElementById("btnHomeHint");

  // í¬ë¡¬ì´ "ì„¤ì¹˜ ê°€ëŠ¥"í•˜ë‹¤ê³  íŒë‹¨í•˜ë©´ ë°œìƒ
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();           // ê¸°ë³¸ ë°°ë„ˆ ë§‰ê³ 
    deferredPrompt = e;           // ì´ë²¤íŠ¸ ì €ì¥
    installBar.style.display = "block";  // í•˜ë‹¨ ë°” í‘œì‹œ
  });

  // ğŸ“² ì•± ì„¤ì¹˜ ë²„íŠ¼
  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) {
      alert("ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆê±°ë‚˜, ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log("ì‚¬ìš©ì ì„ íƒ:", outcome);
    deferredPrompt = null;
    installBar.style.display = "none";   // ì„ íƒ í›„ ë°” ìˆ¨ê¸°ê¸°
  });

  // ğŸ  í™ˆ ë°”ë¡œê°€ê¸° ì•ˆë‚´ ë²„íŠ¼
  btnHomeHint.addEventListener("click", () => {
    const ua = navigator.userAgent;
    if (/SamsungBrowser/i.test(ua)) {
      alert("ì‚¼ì„± ì¸í„°ë„· ë¸Œë¼ìš°ì € ë©”ë‰´(â˜°) > 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ëˆŒëŸ¬ì„œ ë°”ë¡œê°€ê¸°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.");
    } else if (/Chrome/i.test(ua) && /Android/i.test(ua)) {
      alert("í¬ë¡¬ ì˜¤ë¥¸ìª½ ìƒë‹¨ â‹® ë©”ë‰´ > 'í™ˆ í™”ë©´ì— ì¶”ê°€' ë˜ëŠ” 'ì•± ì„¤ì¹˜'ë¥¼ ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤.");
    } else if (/iPhone|iPad|iPod/i.test(ua)) {
      alert("Safari í•˜ë‹¨ ê³µìœ ë²„íŠ¼(â¬†ï¸) > 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ëˆŒëŸ¬ì„œ ë°”ë¡œê°€ê¸°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.");
    } else {
      alert("ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ 'í™ˆ í™”ë©´ì— ì¶”ê°€' ë˜ëŠ” 'ì•± ì„¤ì¹˜' ë©”ë‰´ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.");
    }
  });

  // ====== Service Worker ë“±ë¡ ======
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("Service Worker ë“±ë¡ ì™„ë£Œ"))
      .catch(err => console.log("SW ë“±ë¡ ì˜¤ë¥˜:", err));
  }
</script>

</body>
</html>